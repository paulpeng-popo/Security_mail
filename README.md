# Graduation project about Secure mail

+ **Our system adopts KP-ABE as Searching Algorithm**
+ **Project result: 3/4-complete ( Available for basic functions )**

## File structure and introduction

```
.
├── flask
│   ├── LibServer
│   │   ├── Othertools
│   │   │   ├── __init__.py
│   │   │   └── utils.py
│   │   ├── Search.py
│   │   ├── __init__.py
│   │   └── secret.json
│   ├── backend.wsgi
│   ├── index.html -> templates/index.html
│   ├── nmail.py
│   ├── static -> ../web_resources/
│   └── templates -> ../web/
├── private_server
│   ├── PrivateLib
│   │   ├── PEKS
│   │   │   ├── Othertools
│   │   │   │   ├── __init__.py
│   │   │   │   └── utils.py
│   │   │   ├── Scheme.py
│   │   │   ├── Symcrypt.py
│   │   │   └── __init__.py
│   │   ├── Parser.py
│   │   ├── Receiver.py
│   │   ├── Search.py
│   │   ├── Sender.py
│   │   ├── Server_keys
│   │   ├── __init__.py
│   │   ├── database.py
│   │   └── userdict.txt
│   ├── owen.py
│   ├── private.wsgi
│   ├── static -> ../web_resources/
│   └── templates -> ../web
├── web
│   ├── about.html
│   ├── authors.html
│   ├── compose.html
│   ├── errorpage.html
│   ├── inbox.html
│   ├── index.html
│   ├── privacy.html
│   ├── read.html
│   ├── references.html
│   └── service.html
└── web_resources
    ├── css
    │   ├── about.css
    │   ├── authors.css
    │   ├── compose.css
    │   ├── error.css
    │   ├── inbox.css
    │   ├── index.css
    │   ├── read.css
    │   ├── references.css
    │   └── reset.css
    └── js
        ├── authors.js
        ├── compose.js
        ├── inbox.js
        ├── index.js
        ├── jquery.dad.js
        └── jquery.dad.min.js
```

1. utils.py
    - complemented by us
    - used for operating encryption and decryption
2. Search.py
    - charm prototype architecture
    - used for decrypt email header by search token
    - return plain text list of email header
3. secret.json
    - auto-generated by google
    - password of this project to connect to Gmail APIs
4. nmail.py
    - complemented by us
    - the main logics of Nmail server
5. Scheme.py
    - charm prototype architecture
    - our main KP-ABE logics
6. Symcrypt.py
    - complement by us
    - used for encrypt/decrypt session key for ABE
7. Parser.py & userdict.txt
    - complemented by us
    - chinese/english word parser by jieba-tw package
8. Receiver.py & Sender.py
    - complemented by us
    - handles mails encrypt and decrypt
9. Server_keys
    - stores MSK and MPK
    - must regenerate after it was exposed
10. database.py
    - not functioned
11. owen.py
    - complemented by us
    - the main logics of private server

## How to transplant

### Prerequisite

+ create a new project on google cloud platform
    + required
        + valid domain name (google validation)
    + enable Gmail API
    + complete agreement page
    + create certification in oauth2 client-ID
    + download the client ID and secret token as secret.json

+ env preparation
    + Install apache2 server

+ core packages
    + Install [charm with our configuration](https://github.com/paulpeng-popo/Attribute-Based-Encryption)
        + Ignore the last step
        + Install the version of python3 as same as the instructions
    + Install [jieba-tw](https://github.com/APCLab/jieba-tw)

+ python3 packages
    + flask
    + hashlib
    + pybase64
    + pycryptodomex
    + google.oauth2
    + googleapiclient
    + google_auth_oauthlib
    + werkzeug.datastructures

### Clone files onto machines

+ setup apache2
    + enable mod_wsgi, [official document](https://flask.palletsprojects.com/en/2.0.x/deploying/mod_wsgi/)
        ```bash
            $ apt-get install libapache2-mod-wsgi-py3
        ```
    + try to bind flask server and apache together
    + ( this step is little complicated, be careful ), some example:
        + ~ == /home/ubuntu
        + create ~/flask/backend.wsgi
        ```python3
            activate_this = "/home/ubuntu/py37/bin/activate_this.py"
            with open(activate_this) as file_:
                exec(file_.read(), dict(__file__=activate_this))

            import sys
            sys.path.insert(0, "/home/ubuntu/flask")
            from nmail import app as application
        ```
        + edit /etc/apache2/apache2.conf
        ```conf
            <Directory /home/ubuntu/flask>
                Options FollowSymLinks Includes ExecCGI
                AllowOverride All
                Require all granted
                Allow from all
            </Directory>
        ```
        + create backend.conf
        ```conf
            DocumentRoot "/home/ubuntu/flask"
            <VirtualHost *:80>
                ServerName nsysunmail.ml

                WSGIDaemonProcess Nmail user=www-data group=www-data threads=5
                WSGIScriptAlias / /home/ubuntu/flask/backend.wsgi

                <Directory "/home/ubuntu/flask">
                    WSGIProcessGroup Nmail
                    WSGIApplicationGroup %{GLOBAL}
                    Require all granted
                </Directory>
            </VirtualHost>
        ```

+ replace **[nsysnmail.ml](https://nsysunmail.ml)** by the machine's ipv4 (can be accessed by outer networks) or the custom domain name in files:
    + [nmail.py](./flask/nmail.py)
    + [owen.py](./private_server/owen.py)
    + and the above file (backend.conf)

### Something to be noticed

+ Some absolute path need to modify, and to fit your custom folder path
    + *DOWNLOAD_PATH* in [nmail.py](./flask/nmail.py)
    + *UPLOAD_FOLDER* in [owen.py](./private_server/owen.py)

+ If available (choose one out of two)
    + create front-end server and host [web/*](./web) and [web_resources/*](./web_resources) to retain the consistence of these data between Nmail Server and Private Server
        + modify all html pages requests statements in [nmail.py](./flask/nmail.py) and [owen.py](./private_server/owen.py) replaced by http requests from the built-server
    + or just make soft-link relations, if two servers share common resources **(DEPRECATED)**
        + flask/static -> web_resources
        + flask/templates -> web
        + private_server/static -> web_resources
        + private_server/templates -> web_resources

+ Suggestion:
    + Regenerate the Server_keys before a new system starting in use
